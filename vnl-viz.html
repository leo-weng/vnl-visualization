<!DOCTYPE html>
<script src="/lib/d3.v3.min.js"></script>
<style>
rect.win {fill: blue;}
rect.loss {fill: red;}
</style>
<body>
<div id = "picker"></div>
<div id = "chart-title"></div>
<div id = "chart"></div>
<script type="text/javascript">

var match_data = [];
var team_data = [];
var country_codes = {
    "France": "FRA",
    "USA": "USA",
    "Russia": "RUS",
    "Brazil": "BRA",
    "Poland": "POL",
    "Serbia": "SRB",
    "Italy": "ITA",
    "Canada": "CAN",
    "Japan": "JPN",
    "Germany": "GER",
    "Australia": "AUS",
    "Bulgaria": "BUL",
    "Iran": "IRI",
    "Argentina": "ARG",
    "China": "CHN",
    "Korea": "KOR"
}

console.log("importing data...");
// match data format: 'date', 'win_country', 'loss_country', 'win_score', 'loss_score'
d3.csv("match_data.csv", function(data) {
    // header = d3.keys(data[0]);
    data.forEach(function(d) {
        d["win_score"] = +d["win_score"];
        d["loss_score"] = +d["loss_score"];
    });
    match_data = data;
});

// team data format: 'country', 'rank', 'wins', 'losses'
d3.csv("team_data.csv", function(data) {
    // header = d3.keys(data[0]);
    data.forEach(function(d) {
        d["rank"] = +d["rank"];
        d["wins"] = +d["wins"];
        d["losses"] = +d["losses"];
    });
    team_data = data;
    go();
});

function go() {
    console.log("go...");
    var countries = [];
    for (var i = 0; i < team_data.length; i++) {
        countries.push(team_data[i].country);
    }
    countries.sort();
    var selectedCountry = countries[0];
    showGraph(selectedCountry);

    var margin = {top: 10, bottom: 20, left: window.innerWidth*0.05, right: window.innerWidth*0.05};

    d3.select("#picker")
        .append("text")
        .text("Country: ");

    var select = d3.select("#picker")
        .append("select")
        .attr("class", "select")
        .on("change", onchange);

    var options = select.selectAll("options")
        .data(countries)
        .enter()
        .append("option")
        .text(function(d) { return d;   });

    function onchange() {
        var selectValue = d3.select("select").property("value");
        console.log(selectValue);
        selectedCountry = selectValue;
        d3.select("#chart-title").selectAll("svg").remove();
        d3.select("#chart").selectAll("svg").remove();
        showGraph(selectedCountry);
    }

    function showGraph(selectedCountry) {
        var selectedCountryCode = country_codes[selectedCountry];
        var margin = {top: 10, bottom: 20, left: window.innerWidth*0.05, right: window.innerWidth*0.05};
        var width = window.innerWidth * 0.8;
        var height = 50;
        var title = d3.select("#chart-title")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate (" + margin.left + ", " + margin.top + ") ");
        title.append("text")
            .text(selectedCountry)
            .attr("x", margin.left)
            .attr("y", margin.top);

        var record = [];
        var match_count = 0;
        for (var i = 0; i < 119; i++) {
            var currMatch = match_data[i];
            console.log(selectedCountryCode);
            if (currMatch.win_country == selectedCountryCode) {
                record.push("W " + currMatch.loss_country);
                match_count ++;
            } else if (currMatch.loss_country == selectedCountryCode) {
                record.push("L " + currMatch.win_country);
                match_count ++;
            }
        }

        width = window.innerWidth * 0.8;
        height = window.innerHeight * 0.5;
        var boxWidth = width * 0.9;
        var boxHeight = height * 0.3;
        var gridWidth = boxWidth/match_count;

        addGraph(selectedCountryCode, "one");

        function addGraph(selectedCode, layer) {
            var svg = d3.select("#chart")
                .append("svg")
                .attr("width", width)
                .attr("height", boxHeight)
                .attr("class", layer);

            var g = svg.selectAll("g")
                .data(match_data)
                .enter()
                .append("g");
            g.append("rect")
                .filter(function (d) {
                    return d["win_country"] == selectedCode || d["loss_country"] == selectedCode;
                })
                .attr("x", function (d, i) {
                    return margin.left + i * (gridWidth);
                })
                .attr("y", function (d) {
                    return margin.top;
                })
                .attr("width", gridWidth - 5)
                .attr("height", gridWidth)
                .attr("class", function(d) {
                    if (d["win_country"] == selectedCode) {
                        return "rect win";
                    } else {
                        return "rect loss";
                    }
                })
                .attr("data", function(d) {
                    if (d["win_country"] == selectedCode) {
                        return "W " + d["loss_country"];
                    } else {
                        return "L " + d["win_country"];
                    }
                });

            g.append("text")
                .filter(function (d) {
                    return d["win_country"] == selectedCode || d["loss_country"] == selectedCode;
                })
                .attr("x", function(d, i) {
                    return margin.left + i * (gridWidth) + gridWidth*0.1;
                })
                .attr("y", function(d) {
                    return margin.top + gridWidth / 2;
                })
                // .style("fill", "white")
                .text(function(d) {
                    if (d["win_country"] == selectedCode) {
                        return "W " + d["loss_country"];
                    } else {
                        return "L " + d["win_country"];
                    }
                });
        }



        Object.prototype.getKeyByValue = function( value ) {
            for( var prop in this ) {
                if( this.hasOwnProperty( prop ) ) {
                     if( this[ prop ] === value )
                         return prop;
                }
            }
        }

        var selectCountryCode2 = "";
        var rect = d3.selectAll("svg g rect");
        rect.on('click', function(d) {
            var rect_class = d3.select(this).attr("class");
            if (rect_class == "rect win") {
                selectCountryCode2 = d["loss_country"];
            } else {
                selectCountryCode2 = d["win_country"];
            }
            console.log(selectCountryCode2);
            d3.select("#chart").selectAll("svg.two").remove();
            addGraph(selectCountryCode2, "two");
        });
    }
}

</script>
</body>
</html>
